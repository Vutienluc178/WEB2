<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>C√¥ng c·ª• & Tin t·ª©c To√°n h·ªçc ‚Äì CTST (Pro)</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#f6f7fb; --panel:#ffffff; --fg:#0f172a; --muted:#64748b; --brand:#2563eb; --ring:#93c5fd;
    --card:#ffffff; --border:#e5e7eb; --shadow:0 10px 30px rgba(2,6,23,.08);
    --chip:#eef2ff; --chipText:#3730a3;
    --danger:#ef4444; --warn:#f59e0b;
  }
  .dark{
    --bg:#0b1220; --panel:#0f172a; --fg:#e5e7eb; --muted:#94a3b8; --brand:#60a5fa; --ring:#1d4ed8;
    --card:#0b1220; --border:#1f2937; --shadow:0 12px 28px rgba(0,0,0,.45);
    --chip:#111827; --chipText:#c7d2fe;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg);line-height:1.55}
  header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(160%) blur(8px);background:color-mix(in oklab, var(--panel) 85%, transparent);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:14px 20px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand h1{font-size:20px;margin:0}
  .brand small{color:var(--muted)}
  .controls{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
  .seg{display:inline-grid;grid-auto-flow:column;gap:4px;background:var(--panel);border:1px solid var(--border);border-radius:999px;padding:4px;box-shadow:var(--shadow)}
  .seg button{border:0;background:transparent;padding:8px 14px;border-radius:999px;color:var(--muted);cursor:pointer;font-weight:600;letter-spacing:.2px}
  .seg button.active{background:var(--brand);color:white}
  .search{flex:1;position:relative;min-width:240px}
  .search input{width:100%;padding:10px 12px 10px 38px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--fg);outline:none;box-shadow:var(--shadow)}
  .search svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.6}
  .btn{border:1px solid var(--border);background:var(--panel);color:var(--fg);border-radius:12px;padding:10px 12px;cursor:pointer;box-shadow:var(--shadow)}
  .btn:focus{outline:3px solid var(--ring);outline-offset:2px}
  .btn.small{padding:6px 10px;border-radius:10px}
  .chip{display:inline-flex;gap:6px;align-items:center;background:var(--chip);color:var(--chipText);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
  .chip.active{outline:2px solid var(--brand)}
  main{max-width:1200px;margin:20px auto;padding:0 20px 100px}
  .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .preview{border:1px solid var(--border);border-radius:14px;background:var(--panel);box-shadow:var(--shadow);padding:12px}
  canvas{width:100%;aspect-ratio:16/9;display:block;border-radius:12px;background:linear-gradient(180deg, rgba(99,102,241,.06), transparent)}
  h2.sec{display:flex;align-items:center;gap:10px;margin:22px 0 12px;font-size:18px}
  .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:12px}
  @media(min-width:680px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media(min-width:1024px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .card{border:1px solid var(--border);background:var(--card);border-radius:14px;padding:14px;box-shadow:var(--shadow);transition:transform .15s ease, background .2s ease;position:relative}
  .card:hover{transform:translateY(-3px)}
  .ttl{font-weight:700;font-size:15px;display:flex;gap:8px;align-items:center}
  .desc{color:var(--muted);font-size:13px;margin-top:6px;min-height:36px}
  .ext{margin-left:auto;opacity:.7}
  .meta{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
  .icon{cursor:pointer;user-select:none}
  .icon.disabled{opacity:.35;cursor:not-allowed}
  .badge{display:inline-flex;gap:6px;align-items:center;color:var(--muted);font-size:12px;margin-left:6px}
  .tagbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .panel{border:1px solid var(--border);background:var(--panel);border-radius:12px;padding:10px;box-shadow:var(--shadow)}
  .col2{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:1024px){.col2{grid-template-columns:2fr 1fr}}
  footer{border-top:1px solid var(--border);color:var(--muted);text-align:center;padding:20px}
  .sr{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  dialog{border:1px solid var(--border);border-radius:12px;padding:14px;max-width:520px;width:calc(100% - 2rem);box-shadow:var(--shadow);background:var(--panel);color:var(--fg)}
  dialog::backdrop{background:rgba(0,0,0,.35)}
  .row{display:grid;gap:8px;margin:8px 0}
  .row input, .row textarea{width:100%;border:1px solid var(--border);border-radius:10px;padding:8px;background:var(--card);color:var(--fg)}
  .danger{color:var(--danger);font-weight:600}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3l8 4.5v9L12 21 4 16.5v-9L12 3Z" stroke="currentColor" stroke-width="1.5"/><path d="M12 8v8M8 10l8 4" stroke="currentColor" stroke-width="1.5"/></svg>
      <div>
        <h1>üßÆ C√¥ng c·ª• & Tin t·ª©c To√°n h·ªçc ‚Äì CTST (Pro)</h1>
        <small>T·ªïng h·ª£p ‚Äì tr√¨nh chi·∫øu ‚Äì qu·∫£n l√Ω li√™n k·∫øt</small>
      </div>
    </div>

    <div class="controls">
      <div class="seg" role="tablist" aria-label="Ch·ªçn nh√≥m">
        <button id="tab10" class="active" role="tab" aria-selected="true" onclick="switchTab('toan10')">To√°n 10</button>
        <button id="tab11" role="tab" aria-selected="false" onclick="switchTab('toan11')">To√°n 11</button>
        <button id="tab12" role="tab" aria-selected="false" onclick="switchTab('toan12')">To√°n 12</button>
        <button id="tabtools" role="tab" aria-selected="false" onclick="switchTab('tools')">C√¥ng c·ª• ph·ªï bi·∫øn</button>
        <button id="tabnews" role="tab" aria-selected="false" onclick="switchTab('news')">Tin t·ª©c To√°n h·ªçc</button>
        <button id="tabfav" role="tab" aria-selected="false" onclick="switchTab('favorites')">‚≠ê Y√™u th√≠ch</button>
        <button id="tabrec" role="tab" aria-selected="false" onclick="switchTab('recents')">üïí G·∫ßn ƒë√¢y</button>
      </div>

      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
        <input id="q" type="search" placeholder="T√¨m t√™n / m√¥ t·∫£ / tag (nh·∫•n / ƒë·ªÉ v√†o)" oninput="render()" aria-label="T√¨m ki·∫øm">
      </div>

      <button class="btn" id="modeBtn" onclick="toggleMode()" aria-pressed="false" title="ƒê·ªïi n·ªÅn s√°ng/t·ªëi">üåó Projector</button>
      <button class="btn" onclick="exportJSON()" title="Xu·∫•t d·ªØ li·ªáu JSON">üì§ Export</button>
      <label class="btn" title="Nh·∫≠p JSON (k√©o th·∫£ ho·∫∑c ch·ªçn file)">
        üì• Import <input id="importFile" type="file" accept="application/json" hidden onchange="importJSON(this.files[0])">
      </label>
    </div>
  </div>
</header>

<main>
  <div class="col2">
    <section class="preview panel" aria-label="Canvas minh h·ªça">
      <canvas id="cv" width="960" height="540"></canvas>
      <p class="sr" id="canvasStatus">Canvas s·∫µn s√†ng</p>
    </section>

    <aside class="panel" aria-label="Th√™m nhanh">
      <h3 style="margin:0 0 8px">‚ûï Th√™m li√™n k·∫øt nhanh</h3>
      <div style="display:grid;gap:8px">
        <input id="addTitle" placeholder="Ti√™u ƒë·ªÅ">
        <input id="addPath" placeholder="URL (https://...)">
        <input id="addDesc" placeholder="M√¥ t·∫£ ng·∫Øn">
        <input id="addTags" placeholder="Tags, ngƒÉn c√°ch b·∫±ng d·∫•u , (v√≠ d·ª•: hinh hoc, giai tich)">
        <div style="display:flex;gap:8px;align-items:center">
          <select id="addTab">
            <option value="toan10">To√°n 10</option>
            <option value="toan11">To√°n 11</option>
            <option value="toan12">To√°n 12</option>
            <option value="tools">C√¥ng c·ª• ph·ªï bi·∫øn</option>
            <option value="news">Tin t·ª©c To√°n h·ªçc</option>
          </select>
          <button class="btn small" onclick="addQuick()">L∆∞u</button>
        </div>
        <small style="color:var(--muted)">C√°c m·ª•c tu·ª≥ ch·ªânh s·∫Ω l∆∞u tr√™n tr√¨nh duy·ªát (localStorage). C√≥ th·ªÉ Export ƒë·ªÉ backup.</small>
      </div>
    </aside>
  </div>

  <div class="topbar">
    <div class="tagbar" id="tagbar"></div>
    <button class="btn small" onclick="toggleFavFilter()" title="Ch·ªâ hi·ªÉn th·ªã m·ª•c ƒë√£ ‚≠ê (ph√≠m f)">‚≠ê L·ªçc y√™u th√≠ch</button>
    <span class="badge" id="countBadge">0 m·ª•c</span>
  </div>

  <div id="list" class="grid" aria-live="polite"></div>
</main>

<footer>¬© 2025 ‚Äì GV: V≈© Ti·∫øn L·ª±c ‚Äì Trang t·ªïng h·ª£p c√¥ng c·ª• & tin t·ª©c To√°n h·ªçc</footer>

<!-- EDIT / DELETE DIALOGS -->
<dialog id="editDlg">
  <form method="dialog">
    <h3>‚úèÔ∏è S·ª≠a m·ª•c</h3>
    <div class="row"><label>Ti√™u ƒë·ªÅ<input id="editTitle"></label></div>
    <div class="row"><label>URL<input id="editPath"></label></div>
    <div class="row"><label>M√¥ t·∫£<textarea id="editDesc" rows="3"></textarea></label></div>
    <div class="row"><label>Tags (ph√¢n t√°ch d·∫•u ,)<input id="editTags"></label></div>
    <div class="row" style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" value="cancel">Hu·ª∑</button>
      <button class="btn" id="btnSaveEdit" value="default">L∆∞u</button>
    </div>
  </form>
</dialog>

<dialog id="confirmDlg">
  <form method="dialog">
    <h3 class="danger">‚ö†Ô∏è X√°c nh·∫≠n thao t√°c</h3>
    <p id="confirmMsg">Nh·∫≠p <code>DELETE</code> ƒë·ªÉ x√°c nh·∫≠n.</p>
    <div class="row"><input id="confirmInput" placeholder="G√µ DELETE" autocomplete="off"></div>
    <div class="row" style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" value="cancel">Hu·ª∑</button>
      <button class="btn" id="btnConfirm" value="default">X√°c nh·∫≠n</button>
    </div>
  </form>
</dialog>

<script>
/* ================== D·ªÆ LI·ªÜU M·∫™U (c√≥ tags) ================== */
const baseData = {
  "toan10": [
    {
      "title": "I-1: Kh√°i ni·ªám vect∆°",
      "path": "https://www.congcutoanhoc.com/congcu/vecto/vecto.html",
      "desc": "Th√†nh ph·∫ßn vect∆°; ƒëi·ªÉm ƒë·∫ßu/cu·ªëi, ph∆∞∆°ng, chi·ªÅu, ƒë·ªô d√†i.",
      "tags": [
        "hinh hoc",
        "vector"
      ]
    },
    {
      "title": "I-2: T√≠nh to√°n v·ªõi vect∆°",
      "path": "https://www.congcutoanhoc.com/congcu/vecto/tinhvecto.html",
      "desc": "C·ªông, tr·ª´, nh√¢n vect∆°; v√≠ d·ª• t∆∞∆°ng t√°c.",
      "tags": [
        "hinh hoc",
        "vector",
        "thuc hanh"
      ]
    },
    {
      "title": "III-GI·∫¢I TAM GI√ÅC",
      "path": "https://congcutoanhoc.com/congcu/giaitamgiac/giaitamgiac.html",
      "desc": "GI·∫¢I TAM GI√ÅC",
      "tags": [
        "hethucluong",
        "cosin",
        "sin"
      ]
    }
  ],
  "toan11": [
    {
      "title": "III-1: H√†m s·ªë l∆∞·ª£ng gi√°c",
      "path": "https://www.congcutoanhoc.com/congcu/hamluonggiac/hamluonggiac.html",
      "desc": "ƒê·ªì th·ªã sin, cos, tan, cot; chu k·ª≥ ‚Äì bi√™n ƒë·ªô.",
      "tags": [
        "luong giac",
        "do thi"
      ]
    },
    {
      "title": "III-2: T·ªï h·ª£p ‚Äì X√°c su·∫•t",
      "path": "https://www.congcutoanhoc.com/congcu/xacsuat/xacsuat.html",
      "desc": "M√¥ ph·ªèng x√°c su·∫•t; lu·∫≠t s·ªë l·ªõn.",
      "tags": [
        "xac suat",
        "thong ke"
      ]
    }
  ],
  "toan12": [
    {
      "title": "IV-3: Gi·∫£i tam gi√°c 2",
      "path": "https://www.congcutoanhoc.com/congcu/giaitamgiac/giaitamgiac.html",
      "desc": "ƒê·ªãnh l√Ω sin ‚Äì cos; d·ª±ng h√¨nh.",
      "tags": [
        "hinh hoc",
        "giai tam giac"
      ]
    },
    {
      "title": "IV-4: ƒê∆∞·ªùng ti·ªám c·∫≠n h√†m s·ªë",
      "path": "https://www.congcutoanhoc.com/congcu/tiemcan/tiemcan.html",
      "desc": "Ti·ªám c·∫≠n ƒë·ª©ng, ngang, xi√™n.",
      "tags": [
        "giai tich",
        "do thi"
      ]
    },
    {
      "title": "T·ªåA ƒê·ªò H√åNH CHI·∫æU",
      "path": "https://congcutoanhoc.com/congcu/toadovt/index.html",
      "desc": "X√°c ƒë·ªãnh  t·ªça ƒë·ªô h√¨nh chi·∫øu ƒëi·ªÉm tr√™n Oxyz",
      "tags": [
        "Oxyz"
      ]
    }
  ],
  "tools": [
    {
      "title": "GeoGebra",
      "path": "https://www.geogebra.org/",
      "desc": "C√¥ng c·ª• h√¨nh h·ªçc/ƒë·∫°i s·ªë t∆∞∆°ng t√°c.",
      "tags": [
        "tool",
        "hinh hoc",
        "do thi"
      ]
    },
    {
      "title": "Desmos",
      "path": "https://www.desmos.com/",
      "desc": "ƒê·ªì th·ªã h√†m, ho·∫°t ƒë·ªông l·ªõp h·ªçc.",
      "tags": [
        "tool",
        "do thi"
      ]
    },
    {
      "title": "Wolfram Alpha",
      "path": "https://www.wolframalpha.com/",
      "desc": "T√≠nh to√°n + tri th·ª©c.",
      "tags": [
        "tool",
        "CAS"
      ]
    },
    {
      "title": "Tmp",
      "path": "https://example.com/tmp",
      "desc": "",
      "tags": []
    }
  ],
  "news": [
    {
      "title": "To√°n h·ªçc & ·ª©ng d·ª•ng ‚Äì T·∫°p ch√≠",
      "path": "https://toanhocungdung.vn/",
      "desc": "Tin/b√†i to√°n h·ªçc ·ª©ng d·ª•ng.",
      "tags": [
        "news",
        "vn"
      ]
    },
    {
      "title": "VnExpress ‚Äì Khoa h·ªçc/To√°n",
      "path": "https://vnexpress.net/khoa-hoc/toan-hoc",
      "desc": "M·ª•c To√°n h·ªçc c·ªßa VnExpress.",
      "tags": [
        "news",
        "vn"
      ]
    },
    {
      "title": "MathVN Blog",
      "path": "https://mathvn.net/",
      "desc": "B√†i vi·∫øt, m·∫πo, th·∫£o lu·∫≠n.",
      "tags": [
        "news",
        "blog",
        "vn"
      ]
    }
  ]
};

/* ================== STATE & PERSIST ================== */
let currentTab = 'toan10';
const elList = document.getElementById('list');
const elQ = document.getElementById('q');
const elCount = document.getElementById('countBadge');
const elTagbar = document.getElementById('tagbar');
let favOnly = false;
let editingContext = null; // {source, tab, origPath}

function loadData(){
  const custom = JSON.parse(localStorage.getItem('customData')||'{}');
  const merged = JSON.parse(JSON.stringify(baseData));
  for(const k of Object.keys(custom)){
    if(!merged[k]) merged[k]=[];
    merged[k] = [...merged[k], ...custom[k]];
  }
  return merged;
}
function loadCustom(){ return JSON.parse(localStorage.getItem('customData')||'{}'); }
function saveCustom(data){ localStorage.setItem('customData', JSON.stringify(data)); }
function getFavSet(){ return new Set(JSON.parse(localStorage.getItem('favorites')||'[]')); }
function setFavSet(s){ localStorage.setItem('favorites', JSON.stringify([...s])); }
function pushRecent(item){
  const rec = JSON.parse(localStorage.getItem('recents')||'[]');
  const key = item.path;
  const filtered = rec.filter(r=>r.path!==key);
  filtered.unshift({...item, ts:Date.now()});
  localStorage.setItem('recents', JSON.stringify(filtered.slice(0,12)));
}
function getHidden(){ return new Set(JSON.parse(localStorage.getItem('hiddenPaths')||'[]')); }
function setHidden(set){ localStorage.setItem('hiddenPaths', JSON.stringify([...set])); }

/* ================== MODE (Dark/Projector) ================== */
(function initMode(){
  const saved = localStorage.getItem('mode') || 'light';
  if(saved==='dark') document.documentElement.classList.add('dark');
  document.getElementById('modeBtn').setAttribute('aria-pressed', saved==='dark');
})();
function toggleMode(){
  const root = document.documentElement;
  const dark = root.classList.toggle('dark');
  localStorage.setItem('mode', dark?'dark':'light');
  document.getElementById('modeBtn').setAttribute('aria-pressed', dark);
}

/* ================== TAGS ================== */
function allTagsOf(tabKey){
  const d = loadData();
  const items = tabKey==='favorites' ? allItems().filter(isFav) :
                tabKey==='recents' ? getRecents() : (d[tabKey]||[]);
  const set = new Set();
  items.forEach(i => (i.tags||[]).forEach(t => set.add(t)));
  return [...set].sort();
}
function renderTags(){
  elTagbar.innerHTML = '';
  const tags = allTagsOf(currentTab);
  const active = new Set((new URLSearchParams(location.hash.slice(1))).getAll('tag'));
  tags.forEach(t=>{
    const btn = document.createElement('button');
    btn.className = 'chip' + (active.has(t)?' active':'');
    btn.textContent = `#${t}`;
    btn.onclick = () => toggleTag(t);
    elTagbar.appendChild(btn);
  });
}
function toggleTag(tag){
  const params = new URLSearchParams(location.hash.slice(1));
  if(params.getAll('tag').includes(tag)){
    const arr = params.getAll('tag').filter(x=>x!==tag);
    params.delete('tag');
    arr.forEach(v=>params.append('tag', v));
  }else{
    params.append('tag', tag);
  }
  location.hash = params.toString();
  render(false);
}

/* ================== RENDER ================== */
function switchTab(key){
  currentTab = key;
  document.querySelectorAll('.seg button').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab10').classList.toggle('active', key==='toan10');
  document.getElementById('tab11').classList.toggle('active', key==='toan11');
  document.getElementById('tab12').classList.toggle('active', key==='toan12');
  document.getElementById('tabtools').classList.toggle('active', key==='tools');
  document.getElementById('tabnews').classList.toggle('active', key==='news');
  document.getElementById('tabfav').classList.toggle('active', key==='favorites');
  document.getElementById('tabrec').classList.toggle('active', key==='recents');
  elQ.value='';
  render(true);
}
function allItems(){
  const d = loadData();
  return Object.keys(d).flatMap(k => d[k].map(x => ({...x, _tab:k})));
}
function isFav(it){ return getFavSet().has(it.path); }
function getRecents(){ return JSON.parse(localStorage.getItem('recents')||'[]'); }
function activeTags(){ return new Set((new URLSearchParams(location.hash.slice(1))).getAll('tag')); }

function render(draw=true){
  const d = loadData();
  let list = [];
  if(currentTab==='favorites'){ list = allItems().filter(isFav); }
  else if(currentTab==='recents'){ list = getRecents(); }
  else { list = d[currentTab] || []; }

  // search + hidden filter
  const q = (elQ.value||'').trim().toLowerCase();
  const hidden = getHidden();
  list = list.filter(it=>{
    if(hidden.has(it.path)) return false;
    const hay = (it.title||'')+' '+(it.desc||' ')+' '+(it.tags||[]).join(' ');
    if(q && !hay.toLowerCase().includes(q)) return false;
    if(favOnly && !isFav(it)) return false;
    const chosen = activeTags();
    if(chosen.size){
      const tags = new Set((it.tags||[]));
      for(const t of chosen){ if(!tags.has(t)) return false; }
    }
    return true;
  });

  // render cards
  const favs = getFavSet();
  elList.innerHTML='';
  elCount.textContent = `${list.length} m·ª•c`;
  list.forEach((it)=>{
    const card = document.createElement('article');
    card.className='card';
    card.tabIndex=0;
    card.setAttribute('role','group');
    const fav = favs.has(it.path);
    const inCustom = (loadCustom()[it._tab||currentTab]||[]).some(c=>c.path===it.path);
    const tags = (it.tags||[]).map(t=>`<span class="chip" style="pointer-events:none">${t}</span>`).join(' ');
    card.innerHTML = `
      <div class="ttl">
        <span class="icon open" title="M·ªü (Enter)">üîó</span>
        <span>${it.title}</span>
        <span class="ext" title="Li√™n k·∫øt ngo√†i">‚Üó</span>
      </div>
      <div class="desc">${it.desc||''}</div>
      <div class="meta">
        <span class="icon star" title="ƒê√°nh d·∫•u y√™u th√≠ch">${fav?'‚≠ê':'‚òÜ'}</span>
        <span class="icon copy" title="Sao ch√©p li√™n k·∫øt">üìã</span>
        <span class="icon edit ${inCustom?'':'disabled'}" title="${inCustom? 'S·ª≠a m·ª•c (tu·ª≥ ch·ªânh)':'Sao ch√©p & s·ª≠a (t·∫°o b·∫£n tu·ª≥ ch·ªânh)'}">‚úèÔ∏è</span>
        <span class="icon del" title="${inCustom? 'Xo√° m·ª•c tu·ª≥ ch·ªânh':'·∫®n m·ª•c n√†y kh·ªèi danh s√°ch'}">üóëÔ∏è</span>
        ${tags?`<div style="margin-left:auto;display:flex;gap:6px;flex-wrap:wrap">${tags}</div>`:''}
      </div>
    `;

    // events
    card.querySelector('.open').addEventListener('click',()=>openTool(it,false));
    card.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && (e.metaKey||e.ctrlKey)){ e.preventDefault(); openTool(it, true); }
      else if(e.key==='Enter'){ e.preventDefault(); openTool(it, false); }
    });

    card.querySelector('.star').addEventListener('click', ()=>{
      const set = getFavSet(); set.has(it.path)? set.delete(it.path): set.add(it.path); setFavSet(set); render(false);
    });
    card.querySelector('.copy').addEventListener('click', (e)=>{
      navigator.clipboard?.writeText(it.path); e.target.textContent='‚úÖ'; setTimeout(()=>e.target.textContent='üìã', 800);
    });

    // edit
    card.querySelector('.edit').addEventListener('click', (e)=>{
      const inCustomNow = (loadCustom()[it._tab||currentTab]||[]).some(c=>c.path===it.path);
      if(!inCustomNow){
        // clone base -> custom then open editor
        confirmCloneBase(it).then(ok=>{ if(ok){ openEditDialog({...it, _tab: it._tab||currentTab}); }});
      } else {
        openEditDialog({...it, _tab: it._tab||currentTab});
      }
    });

    // delete / hide with advanced confirmation
    card.querySelector('.del').addEventListener('click', async ()=>{
      const tab = it._tab||currentTab;
      const custom = loadCustom();
      const inCustomNow = (custom[tab]||[]).some(c=>c.path===it.path);
      if(inCustomNow){
        const ok = await confirmByTyping('G√µ DELETE ƒë·ªÉ xo√° m·ª•c tu·ª≥ ch·ªânh n√†y vƒ©nh vi·ªÖn.', 'DELETE');
        if(ok){
          custom[tab] = (custom[tab]||[]).filter(c=>c.path!==it.path);
          saveCustom(custom); render(false);
        }
      }else{
        const ok = await confirmByTyping('G√µ DELETE ƒë·ªÉ ·∫®N m·ª•c g·ªëc n√†y kh·ªèi danh s√°ch (c√≥ th·ªÉ kh√¥i ph·ª•c b·∫±ng c√°ch xo√° hiddenPaths trong LocalStorage).', 'DELETE');
        if(ok){
          const hid = getHidden(); hid.add(it.path); setHidden(hid); render(false);
        }
      }
    });

    elList.appendChild(card);
  });

  renderTags();
  if(draw) drawPreviewTitle(currentTab);
}

/* ================== EDIT DIALOG ================== */
const dlg = document.getElementById('editDlg');
const fTitle = document.getElementById('editTitle');
const fPath  = document.getElementById('editPath');
const fDesc  = document.getElementById('editDesc');
const fTags  = document.getElementById('editTags');

function openEditDialog(item){
  editingContext = { source: 'custom', tab: item._tab, origPath: item.path };
  fTitle.value = item.title||'';
  fPath.value  = item.path||'';
  fDesc.value  = item.desc||'';
  fTags.value  = (item.tags||[]).join(', ');
  dlg.showModal();
}

document.getElementById('btnSaveEdit').addEventListener('click', (e)=>{
  e.preventDefault(); // prevent dialog close by default
  const title = fTitle.value.trim();
  const path  = fPath.value.trim();
  const desc  = fDesc.value.trim();
  const tags  = fTags.value.split(',').map(s=>s.trim()).filter(Boolean);
  if(!title || !/^https?:\/\//i.test(path)) { alert('Vui l√≤ng nh·∫≠p Ti√™u ƒë·ªÅ v√† URL h·ª£p l·ªá.'); return; }
  const custom = loadCustom();
  const tab = editingContext.tab;
  if(!custom[tab]) custom[tab]=[];
  // If path changed, ensure no duplicate
  if(path !== editingContext.origPath && (custom[tab].some(i=>i.path===path) || (baseData[tab]||[]).some(i=>i.path===path))){
    alert('ƒê√£ t·ªìn t·∫°i m·ª•c v·ªõi URL n√†y.'); return;
  }
  // update or insert
  const idx = custom[tab].findIndex(i=>i.path===editingContext.origPath);
  const payload = {title, path, desc, tags};
  if(idx>=0) custom[tab][idx] = payload; else custom[tab].push(payload);
  saveCustom(custom);
  dlg.close(); render(true);
});

dlg.addEventListener('close', ()=>{ editingContext=null; });

/* ================== CONFIRMATION DIALOG (TYPE TO CONFIRM) ================== */
const confirmDlg = document.getElementById('confirmDlg');
const confirmMsg = document.getElementById('confirmMsg');
const confirmInput = document.getElementById('confirmInput');
const btnConfirm = document.getElementById('btnConfirm');

function confirmByTyping(message='Nh·∫≠p DELETE ƒë·ªÉ x√°c nh·∫≠n.', keyword='DELETE'){
  return new Promise(resolve=>{
    confirmMsg.textContent = message + '';
    confirmInput.value='';
    confirmInput.placeholder = `G√µ ${keyword}`;
    const onClose = ()=>{ cleanup(); resolve(false); };
    const onSubmit = (e)=>{
      e.preventDefault();
      const ok = confirmInput.value.trim() === keyword;
      if(ok){ cleanup(); confirmDlg.close('ok'); resolve(true); }
      else {
        confirmInput.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--danger');
        confirmInput.focus();
      }
    };
    function cleanup(){
      confirmDlg.removeEventListener('close', onClose);
      btnConfirm.removeEventListener('click', onSubmit);
      confirmInput.style.borderColor = '';
    }
    confirmDlg.addEventListener('close', onClose, {once:true});
    btnConfirm.addEventListener('click', onSubmit);
    confirmDlg.showModal();
    setTimeout(()=>confirmInput.focus(), 50);
  });
}
function confirmCloneBase(item){
  return new Promise(resolve=>{
    const msg = `M·ª•c n√†y thu·ªôc d·ªØ li·ªáu g·ªëc. G√µ DELETE ƒë·ªÉ t·∫°o m·ªôt b·∫£n tu·ª≥ ch·ªânh r·ªìi ti·∫øn h√†nh s·ª≠a.`;
    confirmByTyping(msg,'DELETE').then(ok=>{
      if(ok){
        const custom = loadCustom();
        const tab = item._tab||currentTab; if(!custom[tab]) custom[tab]=[];
        custom[tab].push({...item}); saveCustom(custom); resolve(true);
      } else { resolve(false); }
    });
  });
}

/* ================== CANVAS ================== */
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
function clearCanvas(){ ctx.clearRect(0,0,cv.width,cv.height); }
function axes(){
  const w=cv.width,h=cv.height;
  ctx.save();
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted');
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(0,h/2);ctx.lineTo(w,h/2);
  ctx.moveTo(w/2,0);ctx.lineTo(w/2,h);
  ctx.stroke();
  // arrows
  ctx.beginPath();
  ctx.moveTo(w-18,h/2-6);ctx.lineTo(w,h/2);ctx.lineTo(w-18,h/2+6);
  ctx.moveTo(w/2-6,18);ctx.lineTo(w/2,0);ctx.lineTo(w/2+6,18);
  ctx.stroke();
  ctx.restore();
}
function wave(color='#60a5fa',amp=80,freq=74){
  const w=cv.width,h=cv.height;
  ctx.save(); ctx.strokeStyle=color; ctx.lineWidth=3; ctx.beginPath();
  for(let x=0;x<w;x++){ const y=h/2-amp*Math.sin(x/freq); x?ctx.lineTo(x,y):ctx.moveTo(x,y); }
  ctx.stroke(); ctx.restore();
}
function label(text){
  ctx.save(); ctx.font="20px ui-sans-serif, system-ui"; ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--fg');
  ctx.fillText(text,24,34); ctx.restore();
}
function drawPreviewTitle(tabKey){
  clearCanvas(); axes();
  const col={toan10:'#38bdf8',toan11:'#22c55e',toan12:'#f59e0b',tools:'#a855f7',news:'#ef4444',favorites:'#f472b6',recents:'#14b8a6'}[tabKey]||'#60a5fa';
  wave(col,70,74);
  const titleMap={
    toan10:'To√°n 10 ‚Äì ƒê·∫°i s·ªë & H√¨nh h·ªçc',
    toan11:'To√°n 11 ‚Äì L∆∞·ª£ng gi√°c & X√°c su·∫•t',
    toan12:'To√°n 12 ‚Äì Gi·∫£i t√≠ch & ·ª®ng d·ª•ng',
    tools:'C√¥ng c·ª• to√°n h·ªçc ph·ªï bi·∫øn',
    news:'Tin t·ª©c & blog To√°n h·ªçc',
    favorites:'M·ª•c ƒë√£ ƒë√°nh d·∫•u ‚≠ê',
    recents:'Li√™n k·∫øt m·ªü g·∫ßn ƒë√¢y'
  };
  label(`üí° ${titleMap[tabKey]}`);
}
function openTool(item, newTab=false){
  clearCanvas(); axes();
  const col={toan10:'#38bdf8',toan11:'#22c55e',toan12:'#f59e0b',tools:'#a855f7',news:'#ef4444',favorites:'#f472b6',recents:'#14b8a6'}[currentTab]||'#60a5fa';
  wave(col,100,60); label(item.title);
  setTimeout(()=>{
    pushRecent(item);
    if(newTab) window.open(item.path,'_blank'); else window.location.href=item.path;
  },600);
}

/* ================== IMPORT / EXPORT / ADD QUICK ================== */
function exportJSON(){
  const data = loadData();
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'math-links.json'; a.click();
  URL.revokeObjectURL(url);
}
function importJSON(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const js = JSON.parse(reader.result);
      // L∆∞u ph·∫ßn kh√°c bi·ªát v√†o customData ƒë·ªÉ kh√¥ng ghi ƒë√® base
      const custom = {};
      for(const k of Object.keys(js)){
        // l·ªçc item kh√¥ng tr√πng v·ªõi base theo path
        const base = (baseData[k]||[]);
        const exist = new Set(base.map(x=>x.path));
        custom[k] = (js[k]||[]).filter(x=>!exist.has(x.path));
      }
      saveCustom(custom);
      render(true);
      alert('‚úÖ ƒê√£ nh·∫≠p d·ªØ li·ªáu!');
    }catch(e){ alert('‚ùå JSON kh√¥ng h·ª£p l·ªá'); }
  };
  reader.readAsText(file);
}
function addQuick(){
  const title = document.getElementById('addTitle').value.trim();
  const path  = document.getElementById('addPath').value.trim();
  const desc  = document.getElementById('addDesc').value.trim();
  const tags  = document.getElementById('addTags').value.trim().split(',').map(s=>s.trim()).filter(Boolean);
  const tab   = document.getElementById('addTab').value;
  if(!title || !/^https?:\/\//i.test(path)){ alert('Vui l√≤ng nh·∫≠p Ti√™u ƒë·ªÅ v√† URL h·ª£p l·ªá (http/https).'); return;}
  const custom = loadCustom();
  if(!custom[tab]) custom[tab]=[];
  // tr√°nh tr√πng path
  if(custom[tab].some(i=>i.path===path) || (baseData[tab]||[]).some(i=>i.path===path)){
    alert('Li√™n k·∫øt ƒë√£ t·ªìn t·∫°i!'); return;
  }
  custom[tab].push({title,path,desc,tags});
  saveCustom(custom);
  // reset form
  document.getElementById('addTitle').value='';
  document.getElementById('addPath').value='';
  document.getElementById('addDesc').value='';
  document.getElementById('addTags').value='';
  document.getElementById('addTab').value=currentTab;
  render(true);
}

/* ================== FAV FILTER & SHORTCUTS ================== */
function toggleFavFilter(){ favOnly=!favOnly; render(false); }
window.addEventListener('keydown', (e)=>{
  if(e.key==='/' && document.activeElement!==elQ){ e.preventDefault(); elQ.focus(); }
  if(e.key.toLowerCase()==='f' && !e.target.matches('input,textarea')){ e.preventDefault(); toggleFavFilter(); }
});

/* ================== INIT ================== */
render(true);
drawPreviewTitle?.noop; // guard
function drawPreviewTitleGuard(){ try{ drawPreviewTitle('toan10'); } catch(e){} }

/* ================== SELF TESTS ================== */
(function(){
  const tests = [];
  const assert = (name, fn) => { try { fn(); tests.push({name, ok:true}); } catch(e){ console.error('Test failed:', name, e); tests.push({name, ok:false, err: String(e)}); } };
  assert('drawPreviewTitle exists', ()=>{ if (typeof drawPreviewTitle !== 'function') throw new Error('missing'); });
  assert('drawPreviewTitle runs for toan10', ()=>{ drawPreviewTitle('toan10'); });
  // new tests for edit/delete
  assert('custom addQuick prevents duplicate path', ()=>{
    const custom = loadCustom(); const tab='tools'; if(!custom[tab]) custom[tab]=[];
    const sample = {title:'Tmp', path:'https://example.com/tmp', desc:'', tags:[]};
    const had = custom[tab].some(i=>i.path===sample.path) || (baseData[tab]||[]).some(i=>i.path===sample.path);
    if(!had){ custom[tab].push(sample); saveCustom(custom); }
    const dup = loadCustom(); if(!dup[tab]) throw new Error('lost tab');
    const cnt = dup[tab].filter(i=>i.path===sample.path).length; if(cnt>1) throw new Error('duplicate allowed');
  });
  assert('confirmByTyping is function', ()=>{ if(typeof confirmByTyping !== 'function') throw new Error('missing confirmByTyping'); });
  console.log('Self-tests:', tests);
})();

drawPreviewTitle('toan10');

// Drag & drop import
document.addEventListener('dragover', e=>{ e.preventDefault(); });
document.addEventListener('drop', e=>{
  e.preventDefault();
  if(e.dataTransfer.files?.[0]) importJSON(e.dataTransfer.files[0]);
});
</script>
</body>
</html>
